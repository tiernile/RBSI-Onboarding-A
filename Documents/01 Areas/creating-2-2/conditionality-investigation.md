# Conditionality Investigation - v2.1 Schema Issues

## Problem Identified
The v2.1 schema generated by `import_non_lux_2_1.py` has **broken visibility conditions**. Fields like "Is it Delaware or Non-Delaware?" are showing up unconditionally instead of only when "USA" is selected.

## Root Cause Analysis

### What's Working (v1.1)
In the working v1.1 schema, visibility conditions are properly structured:
```yaml
visibility:
  -
    entity: entity
    targetKeys:
    allConditionsMustMatch: true
    conditions:
      -
        sourceKey: GENIndicativeAppetiteFundAdminDomicile
        operator: eq
        value: United States
```

### What's Broken (v2.1)
In the broken v2.1 schema, visibility conditions are stored as raw strings:
```yaml
visibility:
  - conditions:
    - raw: GENIndicativeAppetiteFundAdminDomicile = USA
```

## Missing Components in v2.1 Import Script

1. **Visibility Parser**: The v1.1 script has a sophisticated `parse_visibility()` function that:
   - Parses expressions like `"GENIndicativeAppetiteFundAdminDomicile = USA"`
   - Converts operators (`=` → `==`, `<>` → `!=`)
   - Handles AND/OR logic properly
   - Respects quoted values
   - Returns structured visibility rules

2. **Value Canonicalization**: The v1.1 script canonicalizes condition values using `value_aliases` (e.g., "USA" → "United States")

3. **Operator Mapping**: Uses `mapping['normalization']['operators']` to normalize operators

## Impact
- **High**: All conditional fields are showing unconditionally
- **User Experience**: Forms appear broken with fields showing when they shouldn't
- **Testing**: Cannot properly test conditional flows

## Examples of Affected Fields
- Delaware/Non-Delaware selection (should only show when USA selected)
- Pre-application questions (should only show for non-UK jurisdictions)
- 3rd party administrator details (should only show when relevant)
- Many others throughout the form

## Solution Required
Copy the visibility parsing logic from `import_non_lux_1_1.py` into `import_non_lux_2_1.py` and ensure all visibility expressions are properly parsed into the structured format that the UI expects.

## Files to Fix
- `apps/prototype/scripts/import_non_lux_2_1.py` - Missing visibility parser
- `apps/prototype/data/schemas/non-lux-lp-2-1/schema-kycp.yaml` - Needs regeneration